stages:
  - build

build:
  stage: build
  image:
    name: alpine:latest
    entrypoint: ['']
  before_script:
    - apk add --no-cache git curl jq
  variables:
    CONTAINER_REGISTRY: $CI_REGISTRY
  script:
    - echo "Identifying afected apps by this commit..."
    - |
      if [ "$CI_MERGE_REQUEST_IID" ]; then
        # Obtained modified files from Merge Request
        APPS_CHANGED=$(curl --header "PRIVATE-TOKEN: $GITLAB_ACCESS_TOKEN" \
          "http://gitlab/api/v4/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/changes" | \
          jq -r '.changes[].new_path' | grep '^apps/' | cut -d'/' -f2 | sort -u)
      else
        echo "This is not a Merge Request. Exiting...";
        exit 0;
      fi

    - |
      if [ -z "$APPS_CHANGED" ]; then
        echo "There is not apps affectd by this commit. Exiting...";
        exit 0;
      fi

    - |
      for app in $APPS_CHANGED; do
        echo "Building app: $app";
        /kaniko/executor \
          --context "${CI_PROJECT_DIR}/apps/$app" \
          --dockerfile "${CI_PROJECT_DIR}/Dockerfile.prod" \
          --destination "$CONTAINER_REGISTRY/$CI_PROJECT_PATH/$app:${CI_COMMIT_SHA}" \
          --build-arg APP_NAME=$app;
      done
  only:
    - merge_requests
  tags:
    - kaniko
